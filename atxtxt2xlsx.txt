IF STARTSWITH([Field_1], "1CLIENT") THEN 1 ELSE 0 ENDIF

IF [Row-1:TitleFlag] = 1 THEN 1 ELSE 0 ENDIF

IF STARTSWITH([Field_1], "SECURITY") THEN 1 
ELSEIF STARTSWITH([Row-1:Field_1], "SECURITY") THEN 1
ELSEIF [Row-1:HeaderFlag] = 1 THEN 1 
ELSE 0 
ENDIF

[TitleFlag] = 0 AND [PairFlag] = 0 AND [HeaderFlag] = 0

IF MOD([RecordID], 2) = 1 THEN 
  [Field_1] + " " + [Row+1:Field_1] 
ELSE 
  NULL 
ENDIF

import pandas as pd
import re

# Get the Alteryx input
df = Alteryx.read("#1")

# Define a function to parse each CombinedRecord
def parse_combined_record(record):
    fields = {
        'SECURITY': '',
        'CUSIP': '',
        'SECURITY_DESC': '',
        'STOCK_REC_QTY': '',
        'CMS_SEG_QTY': '',
        'CAMS_SEG_QTY': '',
        'DTC_QTY': '',
        'NON_DTC_GCL': '',
        'OPT_SEG_QTY': '',
        'TOTAL': ''
    }
    
    # Start processing the record
    parts = record.split()
    
    # SECURITY
    fields['SECURITY'] = parts.pop(0)
    
    # CUSIP
    fields['CUSIP'] = parts.pop(0)
    
    # SECURITY DESC - collect until a large gap (more than 2 spaces)
    desc = []
    while parts and not re.match(r'\S{2,}', parts[0]):
        desc.append(parts.pop(0))
    fields['SECURITY_DESC'] = ' '.join(desc)
    
    # STOCK REC QTY
    if parts:
        fields['STOCK_REC_QTY'] = parts.pop(0)
    
    # CMS SEG QTY
    if parts:
        fields['CMS_SEG_QTY'] = parts.pop(0)
    
    # CAMS SEG QTY
    if parts:
        fields['CAMS_SEG_QTY'] = parts.pop(0)
    
    # DTC QTY
    if parts:
        fields['DTC_QTY'] = parts.pop(0)
    
    # NON DTC GCL
    if parts:
        fields['NON_DTC_GCL'] = parts.pop(0)
    
    # OPT SEG QTY
    if parts:
        fields['OPT_SEG_QTY'] = parts.pop(0)
    
    # TOTAL
    if parts:
        fields['TOTAL'] = parts.pop(0)
    
    return fields

# Apply the function to each record
parsed_data = df['CombinedRecord'].apply(parse_combined_record)
parsed_df = pd.DataFrame(parsed_data.tolist())

# Concatenate with the original dataframe
result_df = pd.concat([df, parsed_df], axis=1)

# Output the result
Alteryx.write(result_df, 1)






import pandas as pd

# Get the Alteryx input
df = Alteryx.read("#1")

# Define a function to parse each CombinedRecord
def parse_combined_record(record):
    fields = {
        'SECURITY': '',
        'CUSIP': '',
        'SECURITY_DESC': '',
        'STOCK_REC_QTY': '',
        'CMS_SEG_QTY': '',
        'CAMS_SEG_QTY': '',
        'DTC_QTY': '',
        'NON_DTC_GCL': '',
        'OPT_SEG_QTY': '',
        'TOTAL': ''
    }
    
    # Initialize variables for parsing
    parts = record.split()
    idx = 0
    
    # SECURITY
    fields['SECURITY'] = parts[idx]
    idx += 1
    
    # CUSIP
    fields['CUSIP'] = parts[idx]
    idx += 1
    
    # SECURITY DESC
    desc = []
    while idx < len(parts) and ' ' not in parts[idx]:
        desc.append(parts[idx])
        idx += 1
    while idx < len(parts) and ' ' in parts[idx]:
        desc.append(parts[idx])
        idx += 1
    fields['SECURITY_DESC'] = ' '.join(desc).strip()
    
    # STOCK REC QTY
    while idx < len(parts) and parts[idx] == '':
        idx += 1
    if idx < len(parts):
        fields['STOCK_REC_QTY'] = parts[idx]
        idx += 1
    
    # CMS SEG QTY
    while idx < len(parts) and parts[idx] == '':
        idx += 1
    if idx < len(parts):
        fields['CMS_SEG_QTY'] = parts[idx]
        idx += 1
    
    # CAMS SEG QTY
    while idx < len(parts) and parts[idx] == '':
        idx += 1
    if idx < len(parts):
        fields['CAMS_SEG_QTY'] = parts[idx]
        idx += 1
    
    # DTC QTY
    while idx < len(parts) and parts[idx] == '':
        idx += 1
    if idx < len(parts):
        fields['DTC_QTY'] = parts[idx]
        idx += 1
    
    # NON DTC GCL
    while idx < len(parts) and parts[idx] == '':
        idx += 1
    if idx < len(parts):
        fields['NON_DTC_GCL'] = parts[idx]
        idx += 1
    
    # OPT SEG QTY
    while idx < len(parts) and parts[idx] == '':
        idx += 1
    if idx < len(parts):
        fields['OPT_SEG_QTY'] = parts[idx]
        idx += 1
    
    # TOTAL
    while idx < len(parts) and parts[idx] == '':
        idx += 1
    if idx < len(parts):
        fields['TOTAL'] = parts[idx]
    
    return fields

# Apply the function to each record
parsed_data = df['CombinedRecord'].apply(parse_combined_record)
parsed_df = pd.DataFrame(parsed_data.tolist())

# Concatenate with the original dataframe
result_df = pd.concat([df, parsed_df], axis=1)

# Output the result
Alteryx.write(result_df, 1)
