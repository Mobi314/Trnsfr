import pandas as pd
import win32com.client as win32
import xlwings as xw
import shutil
import os
import Alteryx

# Read In Alteryx Input variables
df1 = Alteryx.read("#1")

FilePath = df1["filePath"][0]
SheetNames = df1["SheetNames"]
ExcelPwd = df1["ExcelPwd"][0]

# Define File, Sheets, Password
PATH = FilePath
SHEETS = list(SheetNames)
PASSWORD = ExcelPwd

# Function to create a temporary copy of the Excel file
def create_temp_copy(file_path):
    temp_path = file_path.replace(".xlsx", "_temp.xlsx")
    shutil.copy(file_path, temp_path)
    return temp_path

# Function to remove password from an Excel file
def remove_password_xlsx(file_dir_path, password):
    try:
        xcl = win32.Dispatch("Excel.Application")
        wb = xcl.Workbooks.Open(file_dir_path, False, False, None, password)
        xcl.DisplayAlerts = False
        wb.SaveAs(file_dir_path, None, '.', '.')
        wb.Close(False)  # Ensure workbook is properly closed
        xcl.Quit()
        print(f"Password removed from temporary file: {file_dir_path}")
    except Exception as e:
        print(f"Failed to remove password: {e}")
        raise

# Create a temporary copy of the original file
temp_file_path = create_temp_copy(PATH)

# Remove the password from the temporary file
remove_password_xlsx(temp_file_path, PASSWORD)

# Initialize output DataFrame
out = pd.DataFrame()

# Function to read the temporary file and process the sheets
def process_sheets(temp_file_path, sheets):
    wb = xw.Book(temp_file_path)
    try:
        for sheet in sheets:
            allin = wb.sheets[sheet].used_range.value
            df = pd.DataFrame(allin[1:], columns=allin[0])  # Use the first row as headers
            df["SheetName"] = sheet
            out = pd.concat([out, df], ignore_index=True)
            print(f"Processed sheet: {sheet}")
    except Exception as e:
        print(f"An error occurred while processing sheets: {e}")
    finally:
        wb.close()
    return out

# Process the sheets and get the data
out = process_sheets(temp_file_path, SHEETS)

# Remove temporary file
try:
    os.remove(temp_file_path)
    print(f"Temporary file {temp_file_path} removed")
except Exception as e:
    print(f"Failed to remove temporary file: {e}")

# Unify the format to string for pre-processing
out.columns = out.columns.astype(str)

# Write output to Alteryx
Alteryx.write(out, 1)

if __name__ == '__main__':
    file_dir_path = FilePath
    password = ExcelPwd

    try:
        temp_file_path = create_temp_copy(file_dir_path)
        remove_password_xlsx(temp_file_path, password)
    except Exception as e:
        print(f"Password Removal Failed: {e}")
    else:
        print("Success: Password Removed")


--------------------------------------------------------------------------------------------------------------------------------------


import pandas as pd
import win32com.client
import xlwings as xw
import Alteryx

# Read In Alteryx Input variables
df1 = Alteryx.read("#1")

FilePath = df1["filePath"][0]
SheetNames = df1["SheetNames"]
ExcelPwd = df1["ExcelPwd"][0]

# Define File, Sheets, Password
PATH = FilePath
SHEETS = list(SheetNames)
PASSWORD = ExcelPwd

# Create a function to read a file and remove password
def Remove_password_xlsx(file_dir_path, password):
    xcl = win32com.client.Dispatch("Excel.Application")
    wb = xcl.Workbooks.Open(file_dir_path, False, False, None, password)
    xcl.DisplayAlerts = False
    wb.SaveAs(file_dir_path, None, '.', '.')
    xcl.Quit()

# Create a function to read a file and remove password
def Read_password_xlsx(file_dir_path, password):
    wb = xw.Book(PATH, password=PASSWORD, read_only=True)
    return wb

# Read the workbook with password removed
wb = Read_password_xlsx(PATH, PASSWORD)

# Initialize output DataFrame
out = pd.DataFrame()

# Loop thru wb and append each sheet's data to pandas dataframe
try:
    for sheet in SHEETS:
        allin = wb.sheets[sheet].used_range.value
        df = pd.DataFrame(allin)
        df["SheetName"] = sheet
        df = df.tail(-1)  # Drop first row in dataframe
        out = pd.concat([out, df], ignore_index=True)
except Exception as e:
    print(f"An error has occurred: {e}")

# Unify the format to string for pre-processing
out.columns = out.columns.astype(str)

# Close the workbook
wb.close()

# Write output to Alteryx
Alteryx.write(out, 1)

if __name__ == '__main__':
    file_dir_path = FilePath
    password = ExcelPwd

    try:
        Remove_password_xlsx(file_dir_path, password)
    except Exception as e:
        print(f"Password Removal Failed: {e}")
    else:
        print("Success: Password Removed")
